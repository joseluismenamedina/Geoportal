<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal de Estaciones</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        #map {
            height: calc(100vh - 8px);
            width: calc(100% - 8px);
            margin: 4px;
            border: 4px solid #2563eb;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.3);
        }
        
        /* T√≠tulo del mapa */
        .map-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(37, 99, 235, 0.9);
            color: white;
            padding: 10px 30px;
            border-radius: 30px;
            font-size: 1.5em;
            font-weight: bold;
            z-index: 500;
            box-shadow: 0 2px 15px rgba(0,0,0,0.3);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Panel flotante del formulario */
        .form-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 400px;
            max-height: 90vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .form-header {
            padding: 15px 20px;
            background: linear-gradient(45deg, #3a4ba8, #5a2d8a);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .form-header h1 {
            font-size: 1.3em;
            margin: 0;
        }
        
        .form-tabs {
            display: flex;
            flex-wrap: wrap;
            background: #f0f2f5;
            border-bottom: 1px solid #ddd;
        }
        
        .form-tab {
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 0.85em;
            flex: 1;
            min-width: 80px;
            text-align: center;
        }
        
        .form-tab.active {
            color: #3a4ba8;
            border-bottom: 3px solid #3a4ba8;
            background: white;
        }
        
        .form-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3a4ba8;
            box-shadow: 0 0 0 2px rgba(58, 75, 168, 0.1);
        }
        
        .location-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .form-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
        }
        
        .btn {
            padding: 10px 15px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #3a4ba8, #5a2d8a);
            color: white;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }
        
        .btn-secondary:hover {
            background: #dee2e6;
        }
        
        .location-btn {
            background: #28a745;
            color: white;
            padding: 8px 12px;
            font-size: 13px;
            margin-top: 8px;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .message {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 10px;
            color: #3a4ba8;
            font-weight: 600;
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3a4ba8;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilo para el marcador personalizado */
        .custom-marker {
            background-color: #2563eb;
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        
        .custom-marker::after {
            content: "";
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: #2563eb;
            bottom: -8px;
            left: 7px;
            border-radius: 50%;
            z-index: -1;
        }
        
        .station-popup {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 250px;
        }
        
        .station-popup h3 {
            margin-top: 0;
            color: #3a4ba8;
            font-size: 1.1em;
        }
        
        .station-popup p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .toggle-form-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        /* Panel de b√∫squeda */
        .search-panel {
            position: absolute;
            top: 20px;
            left: 40px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 250px;
        }
        
        .search-panel input {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .search-panel button {
            width: 100%;
            padding: 8px;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .search-panel button:hover {
            background-color: #1d4ed8;
        }
        
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 5px;
            display: none;
        }
        
        .search-result-item {
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .search-result-item:hover {
            background-color: #f0f0f0;
        }

        /* Panel de control de capas */
        .layers-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 250px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .layers-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #3a4ba8;
            font-size: 1.1em;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .layer-item input {
            width: auto;
            margin-right: 10px;
        }
        
        .layer-item label {
            margin: 0;
            flex: 1;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .form-panel {
                width: 90%;
                right: 5%;
                max-height: 70vh;
            }
            
            .toggle-form-btn {
                display: flex;
            }
            
            .form-panel.hidden {
                transform: translateX(120%);
            }

            .map-title {
                font-size: 1.1em;
                padding: 8px 15px;
                top: 10px;
            }
            
            .search-panel {
                width: 200px;
                left: 20px;
            }
            
            .form-tab {
                padding: 6px 8px;
                font-size: 0.8em;
                min-width: 70px;
            }

            .layers-panel {
                width: 200px;
                bottom: 10px;
                left: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- T√≠tulo del Geoportal -->
    <div class="map-title">GEOPORTAL DE TELECOMUNICACIONES</div>
    
    <!-- Panel de b√∫squeda -->
    <div class="search-panel">
        <input type="text" id="searchInput" placeholder="Buscar estaci√≥n por nombre">
        <button id="searchBtn">Buscar Estaci√≥n</button>
        <div class="search-results" id="searchResults"></div>
    </div>
    
    <!-- Panel de control de capas -->
    <div class="layers-panel">
        <h3>Capas Disponibles</h3>
        <div id="layersContainer"></div>
    </div>
    
    <!-- Mapa con marco azul -->
    <div id="map"></div>
    
    <button id="toggleFormBtn" class="toggle-form-btn">üìù</button>
    
    <div class="form-panel">
        <div class="form-header">
            <h1>üì° Registro de Estaciones</h1>
        </div>
        
        <div class="form-tabs">
            <div class="form-tab active" data-tab="general">General</div>
            <div class="form-tab" data-tab="estructura">Estructura</div>
            <div class="form-tab" data-tab="energia">Energ√≠a</div>
            <div class="form-tab" data-tab="ambiental">Ambiental</div>
            <div class="form-tab" data-tab="postes">Postes</div>
            <div class="form-tab" data-tab="equipos">Equipos</div>
        </div>
        
        <div class="form-content">
            <form id="estacionForm">
                <!-- Mensajes y loading -->
                <div id="message" class="message"></div>
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    Enviando datos...
                </div>
                
                <!-- Tab General -->
                <div id="general-tab" class="tab-content active">
                    <div class="form-group">
                        <label for="nombre_estacion">Nombre de la Estaci√≥n *</label>
                        <input type="text" id="nombre_estacion" name="nombre_estacion" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="direccion">Direcci√≥n *</label>
                        <input type="text" id="direccion" name="direccion" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="nombre_tecnico">Nombre del T√©cnico *</label>
                        <input type="text" id="nombre_tecnico" name="nombre_tecnico" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="motivo_visita">Motivo de la Visita *</label>
                        <select id="motivo_visita" name="motivo_visita" required>
                            <option value="">Seleccione un motivo</option>
                            <option value="Mantenimiento">Mantenimiento</option>
                            <option value="Instalaci√≥n">Instalaci√≥n</option>
                            <option value="Reparaci√≥n">Reparaci√≥n</option>
                            <option value="Inspecci√≥n">Inspecci√≥n</option>
                            <option value="Actualizaci√≥n">Actualizaci√≥n</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Ubicaci√≥n GPS *</label>
                        <div class="location-group">
                            <div>
                                <label for="latitud">Latitud *</label>
                                <input type="number" id="latitud" name="latitud" step="any" required placeholder="Ej: -0.1807">
                            </div>
                            <div>
                                <label for="longitud">Longitud *</label>
                                <input type="number" id="longitud" name="longitud" step="any" required placeholder="Ej: -78.4678">
                            </div>
                        </div>
                        <button type="button" class="btn location-btn" onclick="obtenerUbicacion()">
                            üìç Obtener Ubicaci√≥n Actual
                        </button>
                    </div>
                </div>
                
                <!-- Tab Estructura -->
                <div id="estructura-tab" class="tab-content">
                    <div class="form-group">
                        <label for="tipo_estructura">Tipo de Estructura *</label>
                        <select id="tipo_estructura" name="tipo_estructura" required>
                            <option value="">Seleccione tipo</option>
                            <option value="Torre Autosoportada">Torre Autosoportada</option>
                            <option value="Torre Arriostrada">Torre Arriostrada</option>
                            <option value="Monopolo">Monopolo</option>
                            <option value="Azotea">Azotea</option>
                            <option value="Poste">Poste</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="altura_estructura">Altura de la Estructura (m) *</label>
                        <input type="number" id="altura_estructura" name="altura_estructura" min="0" step="0.1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="estado_estructura">Estado de la Estructura *</label>
                        <select id="estado_estructura" name="estado_estructura" required>
                            <option value="">Seleccione estado</option>
                            <option value="Excelente">Excelente</option>
                            <option value="Bueno">Bueno</option>
                            <option value="Regular">Regular</option>
                            <option value="Malo">Malo</option>
                            <option value="Cr√≠tico">Cr√≠tico</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="numero_antenas">N√∫mero de Antenas *</label>
                        <input type="number" id="numero_antenas" name="numero_antenas" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="numero_rru">N√∫mero de RRU *</label>
                        <input type="number" id="numero_rru" name="numero_rru" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipo_transmision">Tipo de Transmisi√≥n *</label>
                        <select id="tipo_transmision" name="tipo_transmision" required>
                            <option value="">Seleccione tipo</option>
                            <option value="Fibra √ìptica">Fibra √ìptica</option>
                            <option value="Microondas">Microondas</option>
                            <option value="Radio Enlace">Radio Enlace</option>
                            <option value="Satelital">Satelital</option>
                            <option value="H√≠brido">H√≠brido</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                </div>
                
                <!-- Tab Energ√≠a -->
                <div id="energia-tab" class="tab-content">
                    <div class="form-group">
                        <label for="tipo_suministro">Tipo de Suministro *</label>
                        <select id="tipo_suministro" name="tipo_suministro" required>
                            <option value="">Seleccione tipo</option>
                            <option value="Red El√©ctrica">Red El√©ctrica</option>
                            <option value="Generador">Generador</option>
                            <option value="Solar">Solar</option>
                            <option value="H√≠brido">H√≠brido</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="numero_medidor">N√∫mero de Medidor</label>
                        <input type="text" id="numero_medidor" name="numero_medidor">
                    </div>
                    
                    <div class="form-group">
                        <label for="voltaje_operacion">Voltaje de Operaci√≥n (V)</label>
                        <input type="number" id="voltaje_operacion" name="voltaje_operacion" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="consumo_energia">Consumo de Energ√≠a (kWh)</label>
                        <input type="number" id="consumo_energia" name="consumo_energia" min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="sistema_respaldo">Sistema de Respaldo</label>
                        <select id="sistema_respaldo" name="sistema_respaldo">
                            <option value="">Seleccione tipo</option>
                            <option value="UPS">UPS</option>
                            <option value="Generador">Generador</option>
                            <option value="Bater√≠as">Bater√≠as</option>
                            <option value="Ninguno">Ninguno</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="autonomia_respaldo">Autonom√≠a de Respaldo (horas)</label>
                        <input type="number" id="autonomia_respaldo" name="autonomia_respaldo" min="0" step="0.1">
                    </div>
                </div>
                
                <!-- Tab Ambiental -->
                <div id="ambiental-tab" class="tab-content">
                    <div class="form-group">
                        <label for="licencia_ambiental">Licencia Ambiental *</label>
                        <select id="licencia_ambiental" name="licencia_ambiental" required>
                            <option value="">Seleccione estado</option>
                            <option value="Vigente">Vigente</option>
                            <option value="Vencida">Vencida</option>
                            <option value="En Tr√°mite">En Tr√°mite</option>
                            <option value="No Aplica">No Aplica</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="numero_licencia">N√∫mero de Licencia</label>
                        <input type="text" id="numero_licencia" name="numero_licencia">
                    </div>
                    
                    <div class="form-group">
                        <label for="fecha_vencimiento">Fecha de Vencimiento</label>
                        <input type="date" id="fecha_vencimiento" name="fecha_vencimiento">
                    </div>
                    
                    <div class="form-group">
                        <label for="entidad_emisora">Entidad Emisora</label>
                        <input type="text" id="entidad_emisora" name="entidad_emisora">
                    </div>
                    
                    <div class="form-group">
                        <label for="estudio_impacto">Estudio de Impacto Ambiental</label>
                        <select id="estudio_impacto" name="estudio_impacto">
                            <option value="">Seleccione estado</option>
                            <option value="Aprobado">Aprobado</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="No Requerido">No Requerido</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="observaciones_ambientales">Observaciones Ambientales</label>
                        <textarea id="observaciones_ambientales" name="observaciones_ambientales" rows="3"></textarea>
                    </div>
                </div>
                
                <!-- Tab Postes -->
                <div id="postes-tab" class="tab-content">
                    <div class="form-group">
                        <label for="numero_postes">N√∫mero de Postes *</label>
                        <input type="number" id="numero_postes" name="numero_postes" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="material_postes">Material de los Postes</label>
                        <select id="material_postes" name="material_postes">
                            <option value="">Seleccione material</option>
                            <option value="Concreto">Concreto</option>
                            <option value="Acero">Acero</option>
                            <option value="Madera">Madera</option>
                            <option value="Fibra de Vidrio">Fibra de Vidrio</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="altura_postes">Altura de Postes (m)</label>
                        <input type="number" id="altura_postes" name="altura_postes" min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="estado_postes">Estado de los Postes</label>
                        <select id="estado_postes" name="estado_postes">
                            <option value="">Seleccione estado</option>
                            <option value="Excelente">Excelente</option>
                            <option value="Bueno">Bueno</option>
                            <option value="Regular">Regular</option>
                            <option value="Malo">Malo</option>
                            <option value="Cr√≠tico">Cr√≠tico</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipo_cimentacion">Tipo de Cimentaci√≥n</label>
                        <select id="tipo_cimentacion" name="tipo_cimentacion">
                            <option value="">Seleccione tipo</option>
                            <option value="Zapata">Zapata</option>
                            <option value="Pilote">Pilote</option>
                            <option value="Losa">Losa</option>
                            <option value="Directa">Directa</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="observaciones_postes">Observaciones sobre Postes</label>
                        <textarea id="observaciones_postes" name="observaciones_postes" rows="3"></textarea>
                    </div>
                </div>
                
                <!-- Tab Equipos -->
                <div id="equipos-tab" class="tab-content">
                    <div class="form-group">
                        <label for="marca_equipos">Marca de Equipos</label>
                        <input type="text" id="marca_equipos" name="marca_equipos">
                    </div>
                    
                    <div class="form-group">
                        <label for="modelo_equipos">Modelo de Equipos</label>
                        <input type="text" id="modelo_equipos" name="modelo_equipos">
                    </div>
                    
                    <div class="form-group">
                        <label for="numero_serie">N√∫mero de Serie</label>
                        <input type="text" id="numero_serie" name="numero_serie">
                    </div>
                    
                    <div class="form-group">
                        <label for="fecha_instalacion">Fecha de Instalaci√≥n</label>
                        <input type="date" id="fecha_instalacion" name="fecha_instalacion">
                    </div>
                    
                    <div class="form-group">
                        <label for="version_software">Versi√≥n de Software</label>
                        <input type="text" id="version_software" name="version_software">
                    </div>
                    
                    <div class="form-group">
                        <label for="estado_equipos">Estado de los Equipos</label>
                        <select id="estado_equipos" name="estado_equipos">
                            <option value="">Seleccione estado</option>
                            <option value="Operativo">Operativo</option>
                            <option value="Con Fallas">Con Fallas</option>
                            <option value="Fuera de Servicio">Fuera de Servicio</option>
                            <option value="En Mantenimiento">En Mantenimiento</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="temperatura_operacion">Temperatura de Operaci√≥n (¬∞C)</label>
                        <input type="number" id="temperatura_operacion" name="temperatura_operacion" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="nivel_senal">Nivel de Se√±al (dBm)</label>
                        <input type="number" id="nivel_senal" name="nivel_senal" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="observaciones_equipos">Observaciones sobre Equipos</label>
                        <textarea id="observaciones_equipos" name="observaciones_equipos" rows="3"></textarea>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="form-footer">
            <button type="button" class="btn btn-secondary" id="prevTabBtn">Anterior</button>
            <button type="button" class="btn btn-primary" id="nextTabBtn">Siguiente</button>
            <button type="submit" class="btn btn-primary" id="submitBtn" style="display: none;">Registrar</button>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Supabase (sin cambios)
        const supabaseUrl = 'https://hzgaoxczhvjbziydzrni.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6Z2FveGN6aHZqYnppeWR6cm5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxMjMwNDgsImV4cCI6MjA2NTY5OTA0OH0.Qpo6KQs1YSEPTPCGrrE3SZZlWKr35IOU5wRBAw65pwA';
        
        // Inicializar Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // Variables para el mapa y marcadores
        let map;
        let markers = {};
        let layerMarkers = {}; // Almacena marcadores por capa
        
        // Variables para el manejo de pesta√±as
        const tabs = ['general', 'estructura', 'energia', 'ambiental', 'postes', 'equipos'];
        let currentTab = 0;

        // Funci√≥n para buscar estaciones por nombre
        async function buscarEstaciones(nombre) {
            try {
                const { data: estaciones, error } = await supabaseClient
                    .from('estaciones')
                    .select('*')
                    .ilike('nombre_estacion', `%${nombre}%`);
                
                if (error) throw error;
                
                return estaciones;
            } catch (error) {
                console.error('Error al buscar estaciones:', error);
                mostrarMensaje('Error al buscar estaciones', 'error');
                return [];
            }
        }

        // Funci√≥n para mostrar resultados de b√∫squeda
        function mostrarResultados(estaciones) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';
            
            if (estaciones.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            estaciones.forEach(estacion => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.textContent = estacion.nombre_estacion;
                item.addEventListener('click', () => {
                    // Centrar el mapa en la estaci√≥n seleccionada
                    map.setView([estacion.latitud, estacion.longitud], 15);
                    
                    // Abrir el popup del marcador
                    if (markers[estacion.id]) {
                        markers[estacion.id].openPopup();
                    }
                    
                    // Ocultar resultados
                    resultsContainer.style.display = 'none';
                });
                resultsContainer.appendChild(item);
            });
            
            resultsContainer.style.display = 'block';
        }

        // Funci√≥n para inicializar el mapa
        function initMap() {
            // Crear el mapa centrado en Ecuador
            map = L.map('map').setView([-1.8312, -78.1834], 7);
            
            // A√±adir capa de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Cargar estaciones existentes
            cargarEstaciones();
            
            // Cargar capas disponibles
            cargarCapasDisponibles();
        }

        // Funci√≥n para cargar estaciones desde Supabase
        async function cargarEstaciones() {
            try {
                const { data: estaciones, error } = await supabaseClient
                    .from('estaciones')
                    .select('*');
                
                if (error) throw error;
                
                // Limpiar marcadores existentes
                Object.values(markers).forEach(marker => map.removeLayer(marker));
                markers = {};
                
                // A√±adir cada estaci√≥n al mapa
                estaciones.forEach(estacion => {
                    agregarEstacionAlMapa(estacion);
                });
                
            } catch (error) {
                console.error('Error al cargar estaciones:', error);
                mostrarMensaje('Error al cargar estaciones en el mapa', 'error');
            }
        }

        // Funci√≥n para agregar una estaci√≥n al mapa
        function agregarEstacionAlMapa(estacion) {
            // Crear el contenido del popup
            const popupContent = `
                <div class="station-popup">
                    <h3>${estacion.nombre_estacion}</h3>
                    <p><strong>Direcci√≥n:</strong> ${estacion.direccion}</p>
                    <p><strong>Tipo:</strong> ${estacion.tipo_estructura}</p>
                    <p><strong>Altura:</strong> ${estacion.altura_estructura} m</p>
                    <p><strong>Antenas:</strong> ${estacion.numero_antenas}</p>
                    <p><strong>Estado:</strong> ${estacion.estado_estructura}</p>
                </div>
            `;
            
            // Crear el marcador con un icono personalizado
            const marker = L.marker([estacion.latitud, estacion.longitud], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: 'üì°',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                })
            }).addTo(map)
              .bindPopup(popupContent);
            
            // Guardar el marcador en el objeto markers
            markers[estacion.id] = marker;
        }

        // Funci√≥n para cargar las tablas disponibles en Supabase
        async function cargarCapasDisponibles() {
            try {
                // Tablas que queremos mostrar como capas
                const tablas = ['estaciones', 'energia', 'permisos_ambientales', 'postes', 'equipos'];
                const layersContainer = document.getElementById('layersContainer');
                layersContainer.innerHTML = '';
                
                // Crear un checkbox para cada tabla
                for (const tabla of tablas) {
                    const layerItem = document.createElement('div');
                    layerItem.className = 'layer-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `layer-${tabla}`;
                    checkbox.value = tabla;
                    checkbox.addEventListener('change', (e) => toggleLayer(e.target.value, e.target.checked));
                    
                    const label = document.createElement('label');
                    label.htmlFor = `layer-${tabla}`;
                    label.textContent = tabla.replace(/_/g, ' ').toUpperCase();
                    
                    layerItem.appendChild(checkbox);
                    layerItem.appendChild(label);
                    layersContainer.appendChild(layerItem);
                    
                    // Inicializar el objeto para almacenar marcadores de esta capa
                    layerMarkers[tabla] = [];
                }
                
            } catch (error) {
                console.error('Error al cargar capas:', error);
            }
        }

        // Funci√≥n para activar/desactivar una capa
        async function toggleLayer(tabla, activar) {
            try {
                // Si se est√° desactivando, eliminar los marcadores
                if (!activar) {
                    layerMarkers[tabla].forEach(marker => map.removeLayer(marker));
                    layerMarkers[tabla] = [];
                    return;
                }
                
                // Si es la tabla de estaciones, cargamos directamente
                if (tabla === 'estaciones') {
                    const { data, error } = await supabaseClient
                        .from(tabla)
                        .select('*');
                    
                    if (error) throw error;
                    
                    // Crear marcadores para cada registro con coordenadas
                    data.filter(registro => registro.latitud && registro.longitud)
                        .forEach(registro => {
                            agregarMarcadorCapa(tabla, registro);
                        });
                    return;
                }
                
                // Para tablas relacionadas, necesitamos hacer join con estaciones para obtener coordenadas
                const { data, error } = await supabaseClient
                    .from(tabla)
                    .select(`*, estaciones:estacion_id (latitud, longitud, nombre_estacion, direccion)`);
                
                if (error) throw error;
                
                // Crear marcadores para cada registro que tenga estaci√≥n asociada con coordenadas
                data.filter(registro => registro.estaciones && registro.estaciones.latitud && registro.estaciones.longitud)
                    .forEach(registro => {
                        // Combinar datos de la tabla con datos de la estaci√≥n
                        const registroCompleto = {
                            ...registro,
                            latitud: registro.estaciones.latitud,
                            longitud: registro.estaciones.longitud,
                            nombre_estacion: registro.estaciones.nombre_estacion,
                            direccion: registro.estaciones.direccion
                        };
                        agregarMarcadorCapa(tabla, registroCompleto);
                    });
                
            } catch (error) {
                console.error(`Error al cargar capa ${tabla}:`, error);
                mostrarMensaje(`Error al cargar capa ${tabla}`, 'error');
            }
        }

        // Funci√≥n para agregar un marcador de capa al mapa
        function agregarMarcadorCapa(tabla, registro) {
            // Definir iconos diferentes para cada tipo de capa
            const iconos = {
                'estaciones': 'üì°',
                'energia': '‚ö°',
                'permisos_ambientales': 'üåø',
                'postes': 'üèóÔ∏è',
                'equipos': 'üíª'
            };
            
            const icono = iconos[tabla] || 'üìç';
            
            // Crear el contenido del popup
            const popupContent = `
                <div class="station-popup">
                    <h3>${registro.nombre_estacion || tabla.replace(/_/g, ' ')}</h3>
                    <p><strong>Tabla:</strong> ${tabla.replace(/_/g, ' ')}</p>
                    ${registro.direccion ? `<p><strong>Direcci√≥n:</strong> ${registro.direccion}</p>` : ''}
                    ${registro.tipo_estructura ? `<p><strong>Tipo:</strong> ${registro.tipo_estructura}</p>` : ''}
                    ${registro.tipo_suministro ? `<p><strong>Suministro:</strong> ${registro.tipo_suministro}</p>` : ''}
                    ${registro.licencia_ambiental ? `<p><strong>Licencia:</strong> ${registro.licencia_ambiental}</p>` : ''}
                    ${registro.marca_equipos ? `<p><strong>Marca:</strong> ${registro.marca_equipos}</p>` : ''}
                </div>
            `;
            
            // Crear el marcador con un icono personalizado
            const marker = L.marker([registro.latitud, registro.longitud], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: icono,
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                })
            }).addTo(map)
              .bindPopup(popupContent);
            
            // Guardar el marcador en el objeto layerMarkers
            layerMarkers[tabla].push(marker);
        }

        // Funci√≥n para obtener ubicaci√≥n actual
        function obtenerUbicacion() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        document.getElementById('latitud').value = position.coords.latitude;
                        document.getElementById('longitud').value = position.coords.longitude;
                        mostrarMensaje('Ubicaci√≥n obtenida correctamente', 'success');
                        
                        // Centrar el mapa en la ubicaci√≥n actual
                        if (map) {
                            map.setView([position.coords.latitude, position.coords.longitude], 15);
                        }
                    },
                    function(error) {
                        let mensaje = 'Error al obtener ubicaci√≥n: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                mensaje += 'Permiso denegado por el usuario';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                mensaje += 'Informaci√≥n de ubicaci√≥n no disponible';
                                break;
                            case error.TIMEOUT:
                                mensaje += 'Tiempo agotado';
                                break;
                            default:
                                mensaje += 'Error desconocido';
                                break;
                        }
                        mostrarMensaje(mensaje, 'error');
                    }
                );
            } else {
                mostrarMensaje('Geolocalizaci√≥n no es compatible con este navegador', 'error');
            }
        }

        // Funci√≥n para mostrar mensajes
        function mostrarMensaje(mensaje, tipo) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = mensaje;
            messageDiv.className = `message ${tipo}`;
            messageDiv.style.display = 'block';
            
            // Ocultar mensaje despu√©s de 5 segundos
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Funci√≥n para mostrar/ocultar loading
        function mostrarLoading(mostrar) {
            const loadingDiv = document.getElementById('loading');
            const submitBtn = document.getElementById('submitBtn');
            
            if (mostrar) {
                loadingDiv.style.display = 'flex';
                submitBtn.disabled = true;
            } else {
                loadingDiv.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        // Funci√≥n para cambiar de pesta√±a
        function cambiarTab(index) {
            // Validar que el √≠ndice est√© dentro del rango
            if (index < 0 || index >= tabs.length) return;
            
            // Actualizar el tab actual
            currentTab = index;
            
            // Actualizar la visualizaci√≥n de los tabs
            document.querySelectorAll('.form-tab').forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Actualizar el contenido de los tabs
            document.querySelectorAll('.tab-content').forEach((content, i) => {
                if (i === index) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // Actualizar botones de navegaci√≥n
            document.getElementById('prevTabBtn').style.display = index === 0 ? 'none' : 'block';
            document.getElementById('nextTabBtn').style.display = index === tabs.length - 1 ? 'none' : 'block';
            document.getElementById('submitBtn').style.display = index === tabs.length - 1 ? 'block' : 'none';
        }

        // Funci√≥n para insertar datos en m√∫ltiples tablas (sin cambios)
        async function insertarDatos(estacionId, datos) {
            const resultados = [];
            
            try {
                // Insertar informaci√≥n de energ√≠a
                if (datos.tipo_suministro) {
                    const energiaData = {
                        estacion_id: estacionId,
                        tipo_suministro: datos.tipo_suministro,
                        numero_medidor: datos.numero_medidor,
                        voltaje_operacion: datos.voltaje_operacion,
                        consumo_energia: datos.consumo_energia,
                        sistema_respaldo: datos.sistema_respaldo,
                        autonomia_respaldo: datos.autonomia_respaldo
                    };
                    
                    const { error: energiaError } = await supabaseClient
                        .from('energia')
                        .insert([energiaData]);
                    
                    if (energiaError) throw energiaError;
                    resultados.push('Energ√≠a registrada');
                }
                
                // Insertar informaci√≥n de permisos ambientales
                if (datos.licencia_ambiental) {
                    const ambientalData = {
                        estacion_id: estacionId,
                        licencia_ambiental: datos.licencia_ambiental,
                        numero_licencia: datos.numero_licencia,
                        fecha_vencimiento: datos.fecha_vencimiento,
                        entidad_emisora: datos.entidad_emisora,
                        estudio_impacto: datos.estudio_impacto,
                        observaciones_ambientales: datos.observaciones_ambientales
                    };
                    
                    const { error: ambientalError } = await supabaseClient
                        .from('permisos_ambientales')
                        .insert([ambientalData]);
                    
                    if (ambientalError) throw ambientalError;
                    resultados.push('Permisos ambientales registrados');
                }
                
                // Insertar informaci√≥n de postes
                if (datos.numero_postes) {
                    const postesData = {
                        estacion_id: estacionId,
                        numero_postes: datos.numero_postes,
                        material_postes: datos.material_postes,
                        altura_postes: datos.altura_postes,
                        estado_postes: datos.estado_postes,
                        tipo_cimentacion: datos.tipo_cimentacion,
                        observaciones_postes: datos.observaciones_postes
                    };
                    
                    const { error: postesError } = await supabaseClient
                        .from('postes')
                        .insert([postesData]);
                    
                    if (postesError) throw postesError;
                    resultados.push('Postes registrados');
                }
                
                // Insertar informaci√≥n de equipos
                if (datos.marca_equipos || datos.modelo_equipos || datos.estado_equipos) {
                    const equiposData = {
                        estacion_id: estacionId,
                        marca_equipos: datos.marca_equipos,
                        modelo_equipos: datos.modelo_equipos,
                        numero_serie: datos.numero_serie,
                        fecha_instalacion: datos.fecha_instalacion,
                        version_software: datos.version_software,
                        estado_equipos: datos.estado_equipos,
                        temperatura_operacion: datos.temperatura_operacion,
                        nivel_senal: datos.nivel_senal,
                        observaciones_equipos: datos.observaciones_equipos
                    };
                    
                    const { error: equiposError } = await supabaseClient
                        .from('equipos')
                        .insert([equiposData]);
                    
                    if (equiposError) throw equiposError;
                    resultados.push('Equipos registrados');
                }
                
                return resultados;
                
            } catch (error) {
                throw error;
            }
        }

        // Manejar env√≠o del formulario (con cambios m√≠nimos)
        document.getElementById('estacionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            mostrarLoading(true);
            
            // Recopilar datos del formulario
            const formData = new FormData(this);
            const datos = {};
            
            formData.forEach((value, key) => {
                // Convertir n√∫meros
                if (['altura_estructura', 'numero_antenas', 'numero_rru', 'latitud', 'longitud', 
                     'voltaje_operacion', 'consumo_energia', 'autonomia_respaldo', 'numero_postes', 
                     'altura_postes', 'temperatura_operacion', 'nivel_senal'].includes(key)) {
                    datos[key] = parseFloat(value) || null;
                } else if (value.trim() !== '') {
                    datos[key] = value;
                }
            });
            
            // Validar coordenadas
            if (!datos.latitud || !datos.longitud) {
                mostrarMensaje('Por favor ingrese las coordenadas GPS', 'error');
                mostrarLoading(false);
                return;
            }
            
            try {
                // Preparar datos para la tabla principal de estaciones
                const estacionData = {
                    nombre_estacion: datos.nombre_estacion,
                    direccion: datos.direccion,
                    nombre_tecnico: datos.nombre_tecnico,
                    motivo_visita: datos.motivo_visita,
                    tipo_estructura: datos.tipo_estructura,
                    altura_estructura: datos.altura_estructura,
                    estado_estructura: datos.estado_estructura,
                    numero_antenas: datos.numero_antenas,
                    numero_rru: datos.numero_rru,
                    tipo_transmision: datos.tipo_transmision,
                    latitud: datos.latitud,
                    longitud: datos.longitud
                };
                
                // Insertar estaci√≥n principal
                const { data: estacionResult, error: estacionError } = await supabaseClient
                    .from('estaciones')
                    .insert([estacionData])
                    .select();
                
                if (estacionError) {
                    throw estacionError;
                }
                
                const estacionId = estacionResult[0].id;
                
                // Insertar datos en tablas relacionadas
                const resultados = await insertarDatos(estacionId, datos);
                
                const mensaje = `¬°Estaci√≥n registrada exitosamente! ${resultados.length > 0 ? 'Tablas adicionales: ' + resultados.join(', ') : ''}`;
                mostrarMensaje(mensaje, 'success');
                document.getElementById('estacionForm').reset();
                
                // Actualizar el mapa con la nueva estaci√≥n
                const nuevaEstacion = { id: estacionId, ...estacionData };
                agregarEstacionAlMapa(nuevaEstacion);
                
                // Centrar el mapa en la nueva estaci√≥n
                map.setView([nuevaEstacion.latitud, nuevaEstacion.longitud], 15);
                
                // Volver al primer tab
                cambiarTab(0);
                
            } catch (error) {
                console.error('Error completo:', error);
                
                // Manejo espec√≠fico de errores
                if (error.code === 'PGRST116' || error.message.includes('Row Level Security')) {
                    mostrarMensaje('Error: No tienes permisos para insertar datos. Verifica la configuraci√≥n de RLS.', 'error');
                } else if (error.code === 'PGRST202' || error.message.includes('relation') || error.message.includes('does not exist')) {
                    mostrarMensaje('Error: Una o m√°s tablas no existen. Ejecuta primero los comandos SQL.', 'error');
                } else {
                    mostrarMensaje('Error al registrar la informaci√≥n: ' + error.message, 'error');
                }
            } finally {
                mostrarLoading(false);
            }
        });

        // Eventos al cargar la p√°gina
        window.addEventListener('load', async function() {
            try {
                // Inicializar el mapa
                initMap();
                
                // Configurar eventos de los tabs
                document.querySelectorAll('.form-tab').forEach((tab, index) => {
                    tab.addEventListener('click', () => cambiarTab(index));
                });
                
                // Configurar botones de navegaci√≥n
                document.getElementById('prevTabBtn').addEventListener('click', () => cambiarTab(currentTab - 1));
                document.getElementById('nextTabBtn').addEventListener('click', () => cambiarTab(currentTab + 1));
                document.getElementById('submitBtn').addEventListener('click', () => {
                    document.getElementById('estacionForm').dispatchEvent(new Event('submit'));
                });
                
                // Configurar bot√≥n para mostrar/ocultar formulario en m√≥viles
                document.getElementById('toggleFormBtn').addEventListener('click', () => {
                    document.querySelector('.form-panel').classList.toggle('hidden');
                });
                
                // Configurar b√∫squeda de estaciones
                document.getElementById('searchBtn').addEventListener('click', async () => {
                    const searchTerm = document.getElementById('searchInput').value.trim();
                    if (searchTerm) {
                        const estaciones = await buscarEstaciones(searchTerm);
                        mostrarResultados(estaciones);
                    }
                });
                
                // Permitir b√∫squeda al presionar Enter
                document.getElementById('searchInput').addEventListener('keypress', async (e) => {
                    if (e.key === 'Enter') {
                        const searchTerm = document.getElementById('searchInput').value.trim();
                        if (searchTerm) {
                            const estaciones = await buscarEstaciones(searchTerm);
                            mostrarResultados(estaciones);
                        }
                    }
                });
                
                // Ocultar resultados al hacer clic fuera
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-panel')) {
                        document.getElementById('searchResults').style.display = 'none';
                    }
                });
                
                // Probar conexi√≥n a Supabase
                const { data, error } = await supabaseClient
                    .from('estaciones')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    if (error.code === 'PGRST202') {
                        mostrarMensaje('‚ö†Ô∏è Tabla no encontrada. Ejecuta primero los comandos SQL.', 'error');
                    } else {
                        mostrarMensaje('‚ö†Ô∏è Error de conexi√≥n: ' + error.message, 'error');
                    }
                } else {
                    mostrarMensaje('‚úÖ Formulario listo para usar. Complete los datos de la estaci√≥n.', 'success');
                }
            } catch (error) {
                mostrarMensaje('‚ö†Ô∏è Error al conectar con la base de datos', 'error');
            }
        });
    </script>
</body>
</html>
