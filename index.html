<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Estaciones - Completo</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Agregamos Leaflet CSS y JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .section h2 {
            color: #555;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        input, select, textarea {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .location-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
            display: none;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .location-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        
        .location-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Estilos para el mapa */
        #map {
            height: 400px;
            width: 100%;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        
        .map-container {
            margin-bottom: 30px;
        }
        
        .map-title {
            text-align: center;
            margin-bottom: 15px;
            color: #555;
            font-size: 1.2em;
        }
        
        .station-popup {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 250px;
        }
        
        .station-popup h3 {
            margin-top: 0;
            color: #667eea;
            font-size: 1.1em;
        }
        
        .station-popup p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .location-group {
                grid-template-columns: 1fr;
            }
            
            #map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì° Registro de Estaciones - Completo</h1>
        
        <!-- Secci√≥n del Mapa -->
        <div class="map-container">
            <div class="map-title">üó∫Ô∏è Mapa de Estaciones Registradas</div>
            <div id="map"></div>
        </div>
        
        <div id="message" class="message"></div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            Enviando datos...
        </div>
        
        <form id="estacionForm">
            <!-- Resto del formulario (sin cambios) -->
            <!-- Secci√≥n Informaci√≥n General -->
            <div class="section">
                <h2>üìç Informaci√≥n General de la Estaci√≥n</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nombre_estacion">Nombre de la Estaci√≥n *</label>
                        <input type="text" id="nombre_estacion" name="nombre_estacion" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="direccion">Direcci√≥n *</label>
                        <input type="text" id="direccion" name="direccion" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="nombre_tecnico">Nombre del T√©cnico *</label>
                        <input type="text" id="nombre_tecnico" name="nombre_tecnico" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="motivo_visita">Motivo de la Visita *</label>
                        <select id="motivo_visita" name="motivo_visita" required>
                            <option value="">Seleccione un motivo</option>
                            <option value="Mantenimiento">Mantenimiento</option>
                            <option value="Instalaci√≥n">Instalaci√≥n</option>
                            <option value="Reparaci√≥n">Reparaci√≥n</option>
                            <option value="Inspecci√≥n">Inspecci√≥n</option>
                            <option value="Actualizaci√≥n">Actualizaci√≥n</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Ubicaci√≥n GPS *</label>
                        <div class="location-group">
                            <div>
                                <label for="latitud">Latitud *</label>
                                <input type="number" id="latitud" name="latitud" step="any" required placeholder="Ej: -0.1807">
                            </div>
                            <div>
                                <label for="longitud">Longitud *</label>
                                <input type="number" id="longitud" name="longitud" step="any" required placeholder="Ej: -78.4678">
                            </div>
                        </div>
                        <button type="button" class="location-btn" onclick="obtenerUbicacion()">
                            üìç Obtener Ubicaci√≥n Actual
                        </button>
                    </div>
                </div>
            </div>

            <!-- Resto de las secciones del formulario (sin cambios) -->
            <!-- Secci√≥n Estructura -->
            <div class="section">
                <h2>üèóÔ∏è Informaci√≥n de Estructura</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tipo_estructura">Tipo de Estructura *</label>
                        <select id="tipo_estructura" name="tipo_estructura" required>
                            <option value="">Seleccione tipo</option>
                            <option value="Torre Autosoportada">Torre Autosoportada</option>
                            <option value="Torre Arriostrada">Torre Arriostrada</option>
                            <option value="Monopolo">Monopolo</option>
                            <option value="Azotea">Azotea</option>
                            <option value="Poste">Poste</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="altura_estructura">Altura de la Estructura (m) *</label>
                        <input type="number" id="altura_estructura" name="altura_estructura" min="0" step="0.1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="estado_estructura">Estado de la Estructura *</label>
                        <select id="estado_estructura" name="estado_estructura" required>
                            <option value="">Seleccione estado</option>
                            <option value="Excelente">Excelente</option>
                            <option value="Bueno">Bueno</option>
                            <option value="Regular">Regular</option>
                            <option value="Malo">Malo</option>
                            <option value="Cr√≠tico">Cr√≠tico</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="numero_antenas">N√∫mero de Antenas *</label>
                        <input type="number" id="numero_antenas" name="numero_antenas" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="numero_rru">N√∫mero de RRU *</label>
                        <input type="number" id="numero_rru" name="numero_rru" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipo_transmision">Tipo de Transmisi√≥n *</label>
                        <select id="tipo_transmision" name="tipo_transmision" required>
                            <option value="">Seleccione tipo</option>
                            <option value="Fibra √ìptica">Fibra √ìptica</option>
                            <option value="Microondas">Microondas</option>
                            <option value="Radio Enlace">Radio Enlace</option>
                            <option value="Satelital">Satelital</option>
                            <option value="H√≠brido">H√≠brido</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n Energ√≠a -->
            <div class="section">
                <h2>‚ö° Informaci√≥n de Energ√≠a</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tipo_suministro">Tipo de Suministro *</label>
                        <select id="tipo_suministro" name="tipo_suministro" required>
                            <option value="">Seleccione tipo</option>
                            <option value="Red El√©ctrica">Red El√©ctrica</option>
                            <option value="Generador">Generador</option>
                            <option value="Solar">Solar</option>
                            <option value="H√≠brido">H√≠brido</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="numero_medidor">N√∫mero de Medidor</label>
                        <input type="text" id="numero_medidor" name="numero_medidor">
                    </div>
                    
                    <div class="form-group">
                        <label for="voltaje_operacion">Voltaje de Operaci√≥n (V)</label>
                        <input type="number" id="voltaje_operacion" name="voltaje_operacion" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="consumo_energia">Consumo de Energ√≠a (kWh)</label>
                        <input type="number" id="consumo_energia" name="consumo_energia" min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="sistema_respaldo">Sistema de Respaldo</label>
                        <select id="sistema_respaldo" name="sistema_respaldo">
                            <option value="">Seleccione tipo</option>
                            <option value="UPS">UPS</option>
                            <option value="Generador">Generador</option>
                            <option value="Bater√≠as">Bater√≠as</option>
                            <option value="Ninguno">Ninguno</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="autonomia_respaldo">Autonom√≠a de Respaldo (horas)</label>
                        <input type="number" id="autonomia_respaldo" name="autonomia_respaldo" min="0" step="0.1">
                    </div>
                </div>
            </div>

            <!-- Secci√≥n Permisos Ambientales -->
            <div class="section">
                <h2>üåø Permisos Ambientales</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="licencia_ambiental">Licencia Ambiental *</label>
                        <select id="licencia_ambiental" name="licencia_ambiental" required>
                            <option value="">Seleccione estado</option>
                            <option value="Vigente">Vigente</option>
                            <option value="Vencida">Vencida</option>
                            <option value="En Tr√°mite">En Tr√°mite</option>
                            <option value="No Aplica">No Aplica</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="numero_licencia">N√∫mero de Licencia</label>
                        <input type="text" id="numero_licencia" name="numero_licencia">
                    </div>
                    
                    <div class="form-group">
                        <label for="fecha_vencimiento">Fecha de Vencimiento</label>
                        <input type="date" id="fecha_vencimiento" name="fecha_vencimiento">
                    </div>
                    
                    <div class="form-group">
                        <label for="entidad_emisora">Entidad Emisora</label>
                        <input type="text" id="entidad_emisora" name="entidad_emisora">
                    </div>
                    
                    <div class="form-group">
                        <label for="estudio_impacto">Estudio de Impacto Ambiental</label>
                        <select id="estudio_impacto" name="estudio_impacto">
                            <option value="">Seleccione estado</option>
                            <option value="Aprobado">Aprobado</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="No Requerido">No Requerido</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="observaciones_ambientales">Observaciones Ambientales</label>
                        <textarea id="observaciones_ambientales" name="observaciones_ambientales" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n Postes -->
            <div class="section">
                <h2>üîå Informaci√≥n de Postes</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="numero_postes">N√∫mero de Postes *</label>
                        <input type="number" id="numero_postes" name="numero_postes" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="material_postes">Material de los Postes</label>
                        <select id="material_postes" name="material_postes">
                            <option value="">Seleccione material</option>
                            <option value="Concreto">Concreto</option>
                            <option value="Acero">Acero</option>
                            <option value="Madera">Madera</option>
                            <option value="Fibra de Vidrio">Fibra de Vidrio</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="altura_postes">Altura de Postes (m)</label>
                        <input type="number" id="altura_postes" name="altura_postes" min="0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="estado_postes">Estado de los Postes</label>
                        <select id="estado_postes" name="estado_postes">
                            <option value="">Seleccione estado</option>
                            <option value="Excelente">Excelente</option>
                            <option value="Bueno">Bueno</option>
                            <option value="Regular">Regular</option>
                            <option value="Malo">Malo</option>
                            <option value="Cr√≠tico">Cr√≠tico</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipo_cimentacion">Tipo de Cimentaci√≥n</label>
                        <select id="tipo_cimentacion" name="tipo_cimentacion">
                            <option value="">Seleccione tipo</option>
                            <option value="Zapata">Zapata</option>
                            <option value="Pilote">Pilote</option>
                            <option value="Losa">Losa</option>
                            <option value="Directa">Directa</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="observaciones_postes">Observaciones sobre Postes</label>
                        <textarea id="observaciones_postes" name="observaciones_postes" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n Equipos -->
            <div class="section">
                <h2>üñ•Ô∏è Informaci√≥n de Equipos</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="marca_equipos">Marca de Equipos</label>
                        <input type="text" id="marca_equipos" name="marca_equipos">
                    </div>
                    
                    <div class="form-group">
                        <label for="modelo_equipos">Modelo de Equipos</label>
                        <input type="text" id="modelo_equipos" name="modelo_equipos">
                    </div>
                    
                    <div class="form-group">
                        <label for="numero_serie">N√∫mero de Serie</label>
                        <input type="text" id="numero_serie" name="numero_serie">
                    </div>
                    
                    <div class="form-group">
                        <label for="fecha_instalacion">Fecha de Instalaci√≥n</label>
                        <input type="date" id="fecha_instalacion" name="fecha_instalacion">
                    </div>
                    
                    <div class="form-group">
                        <label for="version_software">Versi√≥n de Software</label>
                        <input type="text" id="version_software" name="version_software">
                    </div>
                    
                    <div class="form-group">
                        <label for="estado_equipos">Estado de los Equipos</label>
                        <select id="estado_equipos" name="estado_equipos">
                            <option value="">Seleccione estado</option>
                            <option value="Operativo">Operativo</option>
                            <option value="Con Fallas">Con Fallas</option>
                            <option value="Fuera de Servicio">Fuera de Servicio</option>
                            <option value="En Mantenimiento">En Mantenimiento</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="temperatura_operacion">Temperatura de Operaci√≥n (¬∞C)</label>
                        <input type="number" id="temperatura_operacion" name="temperatura_operacion" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="nivel_senal">Nivel de Se√±al (dBm)</label>
                        <input type="number" id="nivel_senal" name="nivel_senal" step="0.1">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="observaciones_equipos">Observaciones sobre Equipos</label>
                        <textarea id="observaciones_equipos" name="observaciones_equipos" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <button type="submit" class="submit-btn">Registrar Informaci√≥n Completa</button>
        </form>
    </div>

    <script>
        // Configuraci√≥n de Supabase
        const supabaseUrl = 'https://hzgaoxczhvjbziydzrni.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6Z2FveGN6aHZqYnppeWR6cm5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxMjMwNDgsImV4cCI6MjA2NTY5OTA0OH0.Qpo6KQs1YSEPTPCGrrE3SZZlWKr35IOU5wRBAw65pwA';
        
        // Inicializar Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // Inicializar el mapa
        let map;
        let markers = {}; // Objeto para almacenar los marcadores

        // Funci√≥n para inicializar el mapa
        function initMap() {
            // Crear el mapa centrado en Ecuador (coordenadas aproximadas)
            map = L.map('map').setView([-1.8312, -78.1834], 7);
            
            // A√±adir capa de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Cargar estaciones existentes
            cargarEstaciones();
        }

        // Funci√≥n para cargar estaciones desde Supabase
        async function cargarEstaciones() {
            try {
                const { data: estaciones, error } = await supabaseClient
                    .from('estaciones')
                    .select('*');
                
                if (error) throw error;
                
                // Limpiar marcadores existentes
                Object.values(markers).forEach(marker => map.removeLayer(marker));
                markers = {};
                
                // A√±adir cada estaci√≥n al mapa
                estaciones.forEach(estacion => {
                    agregarEstacionAlMapa(estacion);
                });
                
            } catch (error) {
                console.error('Error al cargar estaciones:', error);
                mostrarMensaje('Error al cargar estaciones en el mapa', 'error');
            }
        }

        // Funci√≥n para agregar una estaci√≥n al mapa
        function agregarEstacionAlMapa(estacion) {
            // Crear el contenido del popup
            const popupContent = `
                <div class="station-popup">
                    <h3>${estacion.nombre_estacion}</h3>
                    <p><strong>Direcci√≥n:</strong> ${estacion.direccion}</p>
                    <p><strong>Tipo:</strong> ${estacion.tipo_estructura}</p>
                    <p><strong>Altura:</strong> ${estacion.altura_estructura} m</p>
                    <p><strong>Antenas:</strong> ${estacion.numero_antenas}</p>
                    <p><strong>Estado:</strong> ${estacion.estado_estructura}</p>
                </div>
            `;
            
            // Crear el marcador con un icono personalizado
            const marker = L.marker([estacion.latitud, estacion.longitud], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: 'üì°',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                })
            }).addTo(map)
              .bindPopup(popupContent);
            
            // Guardar el marcador en el objeto markers
            markers[estacion.id] = marker;
        }

        // Funci√≥n para obtener ubicaci√≥n actual
        function obtenerUbicacion() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        document.getElementById('latitud').value = position.coords.latitude;
                        document.getElementById('longitud').value = position.coords.longitude;
                        mostrarMensaje('Ubicaci√≥n obtenida correctamente', 'success');
                        
                        // Centrar el mapa en la ubicaci√≥n actual
                        if (map) {
                            map.setView([position.coords.latitude, position.coords.longitude], 15);
                        }
                    },
                    function(error) {
                        let mensaje = 'Error al obtener ubicaci√≥n: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                mensaje += 'Permiso denegado por el usuario';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                mensaje += 'Informaci√≥n de ubicaci√≥n no disponible';
                                break;
                            case error.TIMEOUT:
                                mensaje += 'Tiempo agotado';
                                break;
                            default:
                                mensaje += 'Error desconocido';
                                break;
                        }
                        mostrarMensaje(mensaje, 'error');
                    }
                );
            } else {
                mostrarMensaje('Geolocalizaci√≥n no es compatible con este navegador', 'error');
            }
        }

        // Funci√≥n para mostrar mensajes
        function mostrarMensaje(mensaje, tipo) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = mensaje;
            messageDiv.className = `message ${tipo}`;
            messageDiv.style.display = 'block';
            
            // Ocultar mensaje despu√©s de 5 segundos
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Funci√≥n para mostrar/ocultar loading
        function mostrarLoading(mostrar) {
            const loadingDiv = document.getElementById('loading');
            const submitBtn = document.querySelector('.submit-btn');
            
            if (mostrar) {
                loadingDiv.style.display = 'block';
                submitBtn.disabled = true;
                submitBtn.textContent = 'Enviando...';
            } else {
                loadingDiv.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Registrar Informaci√≥n Completa';
            }
        }

        // Funci√≥n para insertar datos en m√∫ltiples tablas
        async function insertarDatos(estacionId, datos) {
            const resultados = [];
            
            try {
                // Insertar informaci√≥n de energ√≠a
                if (datos.tipo_suministro) {
                    const energiaData = {
                        estacion_id: estacionId,
                        tipo_suministro: datos.tipo_suministro,
                        numero_medidor: datos.numero_medidor,
                        voltaje_operacion: datos.voltaje_operacion,
                        consumo_energia: datos.consumo_energia,
                        sistema_respaldo: datos.sistema_respaldo,
                        autonomia_respaldo: datos.autonomia_respaldo
                    };
                    
                    const { error: energiaError } = await supabaseClient
                        .from('energia')
                        .insert([energiaData]);
                    
                    if (energiaError) throw energiaError;
                    resultados.push('Energ√≠a registrada');
                }
                
                // Insertar informaci√≥n de permisos ambientales
                if (datos.licencia_ambiental) {
                    const ambientalData = {
                        estacion_id: estacionId,
                        licencia_ambiental: datos.licencia_ambiental,
                        numero_licencia: datos.numero_licencia,
                        fecha_vencimiento: datos.fecha_vencimiento,
                        entidad_emisora: datos.entidad_emisora,
                        estudio_impacto: datos.estudio_impacto,
                        observaciones_ambientales: datos.observaciones_ambientales
                    };
                    
                    const { error: ambientalError } = await supabaseClient
                        .from('permisos_ambientales')
                        .insert([ambientalData]);
                    
                    if (ambientalError) throw ambientalError;
                    resultados.push('Permisos ambientales registrados');
                }
                
                // Insertar informaci√≥n de postes
                if (datos.numero_postes) {
                    const postesData = {
                        estacion_id: estacionId,
                        numero_postes: datos.numero_postes,
                        material_postes: datos.material_postes,
                        altura_postes: datos.altura_postes,
                        estado_postes: datos.estado_postes,
                        tipo_cimentacion: datos.tipo_cimentacion,
                        observaciones_postes: datos.observaciones_postes
                    };
                    
                    const { error: postesError } = await supabaseClient
                        .from('postes')
                        .insert([postesData]);
                    
                    if (postesError) throw postesError;
                    resultados.push('Postes registrados');
                }
                
                // Insertar informaci√≥n de equipos
                if (datos.marca_equipos || datos.modelo_equipos || datos.estado_equipos) {
                    const equiposData = {
                        estacion_id: estacionId,
                        marca_equipos: datos.marca_equipos,
                        modelo_equipos: datos.modelo_equipos,
                        numero_serie: datos.numero_serie,
                        fecha_instalacion: datos.fecha_instalacion,
                        version_software: datos.version_software,
                        estado_equipos: datos.estado_equipos,
                        temperatura_operacion: datos.temperatura_operacion,
                        nivel_senal: datos.nivel_senal,
                        observaciones_equipos: datos.observaciones_equipos
                    };
                    
                    const { error: equiposError } = await supabaseClient
                        .from('equipos')
                        .insert([equiposData]);
                    
                    if (equiposError) throw equiposError;
                    resultados.push('Equipos registrados');
                }
                
                return resultados;
                
            } catch (error) {
                throw error;
            }
        }

        // Manejar env√≠o del formulario
        document.getElementById('estacionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            mostrarLoading(true);
            
            // Recopilar datos del formulario
            const formData = new FormData(this);
            const datos = {};
            
            formData.forEach((value, key) => {
                // Convertir n√∫meros
                if (['altura_estructura', 'numero_antenas', 'numero_rru', 'latitud', 'longitud', 
                     'voltaje_operacion', 'consumo_energia', 'autonomia_respaldo', 'numero_postes', 
                     'altura_postes', 'temperatura_operacion', 'nivel_senal'].includes(key)) {
                    datos[key] = parseFloat(value) || null;
                } else if (value.trim() !== '') {
                    datos[key] = value;
                }
            });
            
            // Validar coordenadas
            if (!datos.latitud || !datos.longitud) {
                mostrarMensaje('Por favor ingrese las coordenadas GPS', 'error');
                mostrarLoading(false);
                return;
            }
            
            try {
                // Preparar datos para la tabla principal de estaciones
                const estacionData = {
                    nombre_estacion: datos.nombre_estacion,
                    direccion: datos.direccion,
                    nombre_tecnico: datos.nombre_tecnico,
                    motivo_visita: datos.motivo_visita,
                    tipo_estructura: datos.tipo_estructura,
                    altura_estructura: datos.altura_estructura,
                    estado_estructura: datos.estado_estructura,
                    numero_antenas: datos.numero_antenas,
                    numero_rru: datos.numero_rru,
                    tipo_transmision: datos.tipo_transmision,
                    latitud: datos.latitud,
                    longitud: datos.longitud
                };
                
                // Insertar estaci√≥n principal
                const { data: estacionResult, error: estacionError } = await supabaseClient
                    .from('estaciones')
                    .insert([estacionData])
                    .select();
                
                if (estacionError) {
                    throw estacionError;
                }
                
                const estacionId = estacionResult[0].id;
                
                // Insertar datos en tablas relacionadas
                const resultados = await insertarDatos(estacionId, datos);
                
                const mensaje = `¬°Estaci√≥n registrada exitosamente! ${resultados.length > 0 ? 'Tablas adicionales: ' + resultados.join(', ') : ''}`;
                mostrarMensaje(mensaje, 'success');
                document.getElementById('estacionForm').reset();
                
                // Actualizar el mapa con la nueva estaci√≥n
                const nuevaEstacion = { id: estacionId, ...estacionData };
                agregarEstacionAlMapa(nuevaEstacion);
                
                // Centrar el mapa en la nueva estaci√≥n
                map.setView([nuevaEstacion.latitud, nuevaEstacion.longitud], 15);
                
            } catch (error) {
                console.error('Error completo:', error);
                
                // Manejo espec√≠fico de errores
                if (error.code === 'PGRST116' || error.message.includes('Row Level Security')) {
                    mostrarMensaje('Error: No tienes permisos para insertar datos. Verifica la configuraci√≥n de RLS.', 'error');
                } else if (error.code === 'PGRST202' || error.message.includes('relation') || error.message.includes('does not exist')) {
                    mostrarMensaje('Error: Una o m√°s tablas no existen. Ejecuta primero los comandos SQL.', 'error');
                } else {
                    mostrarMensaje('Error al registrar la informaci√≥n: ' + error.message, 'error');
                }
            } finally {
                mostrarLoading(false);
            }
        });
        
        // Verificar conexi√≥n al cargar
        window.addEventListener('load', async function() {
            try {
                // Inicializar el mapa
                initMap();
                
                // Probar conexi√≥n a Supabase
                const { data, error } = await supabaseClient
                    .from('estaciones')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    if (error.code === 'PGRST202') {
                        mostrarMensaje('‚ö†Ô∏è Tabla no encontrada. Ejecuta primero los comandos SQL.', 'error');
                    } else {
                        mostrarMensaje('‚ö†Ô∏è Error de conexi√≥n: ' + error.message, 'error');
                    }
                } else {
                    mostrarMensaje('‚úÖ Formulario listo para usar. Complete los datos de la estaci√≥n.', 'success');
                }
            } catch (error) {
                mostrarMensaje('‚ö†Ô∏è Error al conectar con la base de datos', 'error');
            }
        });
    </script>
</body>
</html>
